--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Init and Register the necessary jars
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
set default_parallel 200;
register '/opt/maged/pig-jars/*.jar'
register '/home/gijs/lib/adsafe-pigudfs.jar'
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Remove Old Folders
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
RMF d4d/set1/text_total;
RMF d4d/set1/text_weekday;
RMF d4d/set1/text_month;
RMF d4d/set1/text_hour;
RMF d4d/set1/text_week;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Pull data
--- 
--- --------------------------------------------------------------------------------------------------------------------------------------------
data = LOAD '/user/gijs/d4d/set1/text' USING PigStorage(',') AS (timestamp:chararray, outgoing: int, incoming: int, nTexts: int);
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
--- 
--- Pre-process 1
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
data = FOREACH data GENERATE
	ToDate(SUBSTRING(timestamp,0,10)) AS dt,
	com.adsafe.pigudfs.geolocation.ISOToDayOfWeek(SUBSTRING(timestamp,0,10)) AS weekday,
	(int)SUBSTRING(timestamp,11,13) AS hour: int,
	outgoing AS outgoing,
	incoming AS incoming,
	nTexts AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
--- 
--- Pre-process 1
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
data = FOREACH data GENERATE
	GetMonth(dt) AS month: int,
	GetWeek(dt) AS week: int,
	weekday AS weekday: int,
	hour AS hour: int,
	outgoing AS outgoing,
	incoming AS incoming,
	nTexts AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Group
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
total = FOREACH (GROUP data BY (outgoing,incoming)) GENERATE
	group AS C,
	SUM(data.nTexts) AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Group by month
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
month = FOREACH (GROUP data BY (month,outgoing,incoming)) GENERATE
	group AS C,
	SUM(data.nTexts) AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Group by month
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
week = FOREACH (GROUP data BY (week,outgoing,incoming)) GENERATE
	group AS C,
	SUM(data.nTexts) AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Group by month
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
weekday = FOREACH (GROUP data BY (weekday,outgoing,incoming)) GENERATE
	group AS C,
	SUM(data.nTexts) AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
--- Group by month
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
hour = FOREACH (GROUP data BY (hour,outgoing,incoming)) GENERATE
	group AS C,
	SUM(data.nTexts) AS nTexts;
--- --------------------------------------------------------------------------------------------------------------------------------------------




--- --------------------------------------------------------------------------------------------------------------------------------------------
---
---  Store
---
--- --------------------------------------------------------------------------------------------------------------------------------------------
STORE total INTO 'd4d/set1/text_total' USING PigStorage('\t', '-schema');
STORE month INTO 'd4d/set1/text_month' USING PigStorage('\t', '-schema');
STORE week INTO 'd4d/set1/text_week' USING PigStorage('\t', '-schema');
STORE hour INTO 'd4d/set1/text_hour' USING PigStorage('\t', '-schema');
STORE weekday INTO 'd4d/set1/text_weekday' USING PigStorage('\t', '-schema');
--- --------------------------------------------------------------------------------------------------------------------------------------------
